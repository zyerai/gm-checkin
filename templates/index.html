{% extends "base.html" %}

{% block content %}
<div class="calendar-page">
    <!-- ç»Ÿè®¡å¡ç‰‡ -->
    <div class="stats-bar">
        <div class="stat-item">
            <div class="stat-icon">ğŸ”¥</div>
            <div class="stat-content">
                <div class="stat-label">è¿ç»­æ‰“å¡</div>
                <div class="stat-value">{{ streak }} å¤©</div>
            </div>
        </div>

        <div class="stat-item">
            <div class="stat-icon">âœ…</div>
            <div class="stat-content">
                <div class="stat-label">ç´¯è®¡æ‰“å¡</div>
                <div class="stat-value">{{ total_checkins }} å¤©</div>
            </div>
        </div>

        <div class="stat-item">
            <div class="stat-icon">ğŸ“…</div>
            <div class="stat-content">
                <div class="stat-label">ä»Šå¤©</div>
                <div class="stat-value">{{ today.strftime('%m-%d') }}</div>
            </div>
        </div>
    </div>

    <!-- ä»Šå¤©æ‰“å¡æŒ‰é’® -->
    <div class="today-checkin">
        {% if today.isoformat() in checkins %}
        <div class="checked-in">
            <h2>âœ… ä»Šå¤©å·²æ‰“å¡</h2>
            <p>Keep Grinding! ğŸ’ª</p>
            <button onclick="showCheckinForm()" class="btn-secondary">æ›´æ–°æ‰“å¡</button>
        </div>
        {% else %}
        <div class="not-checked-in">
            <h2>ä»Šå¤©è¿˜æ²¡æœ‰æ‰“å¡</h2>
            <p>GM! Let's go! ğŸš€</p>
            <button onclick="showCheckinForm()" class="btn-primary">ç«‹å³æ‰“å¡</button>
        </div>
        {% endif %}
    </div>

    <!-- æ‰“å¡è¡¨å•ï¼ˆé»˜è®¤éšè—ï¼‰ -->
    <div id="checkinForm" class="checkin-form" style="display: none;">
        <h3>ä»Šå¤©æ‰“å¡</h3>
        <form method="POST" action="{{ url_for('checkin') }}">
            <div class="form-group">
                <label>æ—¥æœŸ</label>
                <input type="date" name="checkin_date" value="{{ today.isoformat() }}" required>
            </div>

            <div class="form-group">
                <label>ä»Šæ—¥å¿ƒæƒ…</label>
                <div class="mood-selector">
                    <label class="mood-option">
                        <input type="radio" name="mood" value="gm" checked>
                        <span>ğŸŒ… GM</span>
                    </label>
                    <label class="mood-option">
                        <input type="radio" name="mood" value="bullish">
                        <span>ğŸš€ Bullish</span>
                    </label>
                    <label class="mood-option">
                        <input type="radio" name="mood" value="focused">
                        <span>ğŸ’ª Focused</span>
                    </label>
                    <label class="mood-option">
                        <input type="radio" name="mood" value="learning">
                        <span>ğŸ“š Learning</span>
                    </label>
                    <label class="mood-option">
                        <input type="radio" name="mood" value="chill">
                        <span>ğŸ˜Œ Chill</span>
                    </label>
                    <label class="mood-option">
                        <input type="radio" name="mood" value="grinding">
                        <span>âš¡ Grinding</span>
                    </label>
                </div>
            </div>

            <div class="form-group">
                <label>ä»Šæ—¥å¤‡æ³¨ (å¯é€‰)</label>
                <textarea name="notes" rows="3" placeholder="ä»Šå¤©è®¡åˆ’åšä»€ä¹ˆï¼Ÿæˆ–è€…è®°å½•ä¸€äº›æƒ³æ³•..."></textarea>
            </div>

            <div class="form-actions">
                <button type="submit" class="btn-primary">æ‰“å¡ï¼</button>
                <button type="button" onclick="generateGM()" class="btn-secondary">ç”ŸæˆGMæ–‡æ¡ˆ</button>
                <button type="button" onclick="hideCheckinForm()" class="btn-cancel">å–æ¶ˆ</button>
            </div>
        </form>

        <div id="gmResult" class="gm-result" style="display: none;">
            <h4>ğŸ“ ä½ çš„GMæ–‡æ¡ˆï¼š</h4>
            <p id="gmText"></p>
            <button onclick="copyGM()" class="btn-small">å¤åˆ¶</button>
        </div>
    </div>

    <!-- æ—¥å† -->
    <div class="calendar-section">
        <div class="calendar-header">
            <a href="{{ url_for('index', year=prev_year, month=prev_month) }}" class="nav-btn">&lt; ä¸Šä¸ªæœˆ</a>
            <h2>{{ month_name }} {{ year }}</h2>
            <a href="{{ url_for('index', year=next_year, month=next_month) }}" class="nav-btn">ä¸‹ä¸ªæœˆ &gt;</a>
        </div>

        <div class="calendar-grid">
            <div class="calendar-day-header">Mon</div>
            <div class="calendar-day-header">Tue</div>
            <div class="calendar-day-header">Wed</div>
            <div class="calendar-day-header">Thu</div>
            <div class="calendar-day-header">Fri</div>
            <div class="calendar-day-header">Sat</div>
            <div class="calendar-day-header">Sun</div>

            {% for week in month_days %}
            {% for day in week %}
            {% if day == 0 %}
            <div class="calendar-day empty"></div>
            {% else %}
            {% set date_str = '%d-%02d-%02d'|format(year, month, day) %}
            <div class="calendar-day {% if date_str in checkins %}checked{% endif %} {% if date_str == today.isoformat() %}today{% endif %}">
                <div class="day-number">{{ day }}</div>
                {% if date_str in checkins %}
                <div class="checkin-mark">{{ checkins[date_str]['mood']|mood_emoji }}</div>
                {% if checkins[date_str]['notes'] %}
                <div class="day-notes" title="{{ checkins[date_str]['notes'] }}">ğŸ“</div>
                {% endif %}
                {% endif %}
            </div>
            {% endif %}
            {% endfor %}
            {% endfor %}
        </div>
    </div>
</div>

<script>
function showCheckinForm() {
    document.getElementById('checkinForm').style.display = 'block';
    document.getElementById('checkinForm').scrollIntoView({ behavior: 'smooth' });
}

function hideCheckinForm() {
    document.getElementById('checkinForm').style.display = 'none';
}

function generateGM() {
    const mood = document.querySelector('input[name="mood"]:checked').value;
    fetch(`/generate_gm?mood=${mood}`)
        .then(response => response.json())
        .then(data => {
            document.getElementById('gmText').textContent = data.gm_text;
            document.getElementById('gmResult').style.display = 'block';
        });
}

function copyGM() {
    const text = document.getElementById('gmText').textContent;
    navigator.clipboard.writeText(text).then(() => {
        alert('å·²å¤åˆ¶åˆ°å‰ªè´´æ¿ï¼');
    });
}
</script>
{% endblock %}
